<?xml version="1.0"?>
<project name="widgetsgallery">
    <property name="build.root" value="../../.."/>
    <property name="build.dir" value="${build.root}/duibuild"/>
    <property name="dist.dir" value="${build.root}/widgetsgallery"/>
    <property name="libdui.dir" value="${build.dir}/libdui"/>
    <property name="theme.dir" value="${build.dir}/libdui"/>
    <property name="widgetsgallery.dir" value="${libdui.dir}/demos/widgetsgallery"/>
    <property name="git" value="/opt/local/bin/git"/>
    <property name="macdeployqt" value="/usr/bin/macdeployqt"/>
    <property name="local.frameworks.dir" value="/Users/dubik/Library/Frameworks"/>

    <target name="dmg" depends="create-dmg">
    </target>

    <target name="init">
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${dist.dir}"/>
        <delete includeemptydirs="true" failonerror="false">
            <fileset dir="${widgetsgallery.dir}/widgetsgallery.app"/>
        </delete>
        <delete includeemptydirs="true" failonerror="false">
            <fileset dir="${build.root}/widgetsgallery"/>
        </delete>
        <delete file="${build.root}/widgetsgallery.dmg" failonerror="false"/>
    </target>

    <target name="clean">
        <delete dir="duidist"/>
        <delete dir="duibuild"/>
    </target>

    <target name="configure" depends="init">
        <exec executable="/bin/sh" dir="${libdui.dir}">
            <arg line="configure --prefix=/usr"/>
        </exec>
    </target>

    <target name="qmake" depends="configure">
        <exec executable="qmake" dir="${libdui.dir}">
            <arg line="-spec macx-g++ -r"/>
        </exec>
    </target>

    <target name="compile" depends="qmake">
        <exec executable="make" failonerror="yes" dir="${libdui.dir}">
            <arg line="-j 2"/>
        </exec>
    </target>

    <target name="macdeployqt" depends="deploy-meego-touch-framework">
        <exec executable="${macdeployqt}" dir="${widgetsgallery.dir}">
            <arg line="widgetsgallery.app"/>
            <arg line="-verbose=2"/>
        </exec>
        <!-- Deleting meegotouchcore.framework and meegotouchviews.framework so that it doesn't clash with other projects -->
        <delete includeemptydirs="true">
            <fileset dir="${local.frameworks.dir}/meegotouchcore.framework" includes="**/*"/>
            <fileset dir="${local.frameworks.dir}/meegotouchviews.framework" includes="**/*"/>
        </delete>
    </target>

    <target name="deploy-meego-touch-framework" depends="compile">
        <copy todir="${local.frameworks.dir}/meegotouchcore.framework">
            <fileset dir="${libdui.dir}/lib/meegotouchcore.framework"/>
        </copy>
        <copy todir="${local.frameworks.dir}/meegotouchviews.framework">
            <fileset dir="${libdui.dir}/lib/meegotouchviews.framework"/>
        </copy>
    </target>

    <target name="copy-widgetsgallery" depends="macdeployqt">
        <copy todir="${dist.dir}/widgetsgallery.app">
            <fileset dir="${widgetsgallery.dir}/widgetsgallery.app"/>
        </copy>
        <exec executable="chmod" failonerror="false">
            <arg line="a+x ${dist.dir}/widgetsgallery.app/Contents/MacOS/widgetsgallery"/>
        </exec>
    </target>
    
    <target name="package-duitheme" depends="copy-widgetsgallery">
        <exec executable="/Developer/usr/bin/packagemaker" failonerror="true">
            <arg line="--doc ${libdui.dir}/tools/duitheme.pmdoc"/>
            <arg line="--out ${dist.dir}/duitheme.pkg"/>
        </exec>
    </target>

    <target name="create-dmg" depends="package-duitheme">
        <exec  executable="/usr/bin/hdiutil" failonerror="true" dir="${build.root}">
            <arg line="create ./widgetsgallery.dmg"/>
            <arg line="-srcfolder widgetsgallery"/>
            <arg line="-ov"/>
        </exec>
    </target>
</project>
